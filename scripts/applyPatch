#!/usr/bin/env bash
# applyPatch â€” fix hunk counts, then git apply (clipboard-first).
# Usage:
#   scripts/applyPatch                 # reads diff from clipboard (pbpaste)
#   pbpaste | scripts/applyPatch       # reads diff from stdin
#   scripts/applyPatch patch.diff      # reads diff from file
#   scripts/applyPatch --from-clipboard

set -euo pipefail

tmp_in="$(mktemp -t applyPatch.in.XXXXXX)"
tmp_fixed="$(mktemp -t applyPatch.fixed.XXXXXX)"
cleanup() { rm -f "$tmp_in" "$tmp_fixed"; }
trap cleanup EXIT

read_from_stdin=false
read_from_file=""
read_from_clipboard=false

# Parse args
if [[ $# -gt 0 ]]; then
  case "${1:-}" in
    --from-clipboard)
      read_from_clipboard=true
      ;;
    -*)
      echo "Unknown option: $1" >&2
      echo "Usage: scripts/applyPatch [--from-clipboard] | pbpaste | scripts/applyPatch | scripts/applyPatch patch.diff" >&2
      exit 2
      ;;
    *)
      read_from_file="$1"
      ;;
  esac
fi

# Decide input source
if [ ! -t 0 ] && [[ -z "$read_from_file" && "$read_from_clipboard" = false ]]; then
  read_from_stdin=true
elif [[ -n "$read_from_file" ]]; then
  :
else
  # default to clipboard when no stdin and no file
  read_from_clipboard=true
fi

# Load input
if [[ "$read_from_stdin" = true ]]; then
  cat > "$tmp_in"
elif [[ -n "$read_from_file" ]]; then
  if [[ ! -f "$read_from_file" ]]; then
    echo "File not found: $read_from_file" >&2
    exit 1
  fi
  cp "$read_from_file" "$tmp_in"
elif [[ "$read_from_clipboard" = true ]]; then
  if ! command -v pbpaste >/dev/null 2>&1; then
    echo "pbpaste not found. Provide a file or pipe stdin." >&2
    exit 1
  fi
  pbpaste > "$tmp_in"
  if [[ ! -s "$tmp_in" ]]; then
    echo "Clipboard is empty or not a diff. Copy a unified diff to the clipboard and retry." >&2
    exit 1
  fi
else
  echo "No input detected. Use stdin, a file, or --from-clipboard." >&2
  exit 1
fi

# Resolve fixers: prefer Swift, fall back to awk, search scripts/ if not on PATH
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
fix_swift=""
if command -v fixDiffCounts.swift >/dev/null 2>&1; then
  fix_swift="$(command -v fixDiffCounts.swift)"
elif [[ -x "$script_dir/fixDiffCounts.swift" ]]; then
  fix_swift="$script_dir/fixDiffCounts.swift"
fi

fix_awk=""
if command -v fix-diff-counts.sh >/dev/null 2>&1; then
  fix_awk="$(command -v fix-diff-counts.sh)"
elif [[ -x "$script_dir/fix-diff-counts.sh" ]]; then
  fix_awk="$script_dir/fix-diff-counts.sh"
fi

if [[ -n "$fix_swift" ]]; then
  "$fix_swift" -f "$tmp_in" > "$tmp_fixed"
elif [[ -n "$fix_awk" ]]; then
  "$fix_awk" "$tmp_in" > "$tmp_fixed"
else
  echo "No diff count fixer found (need fixDiffCounts.swift or fix-diff-counts.sh)." >&2
  exit 1
fi

# Verify and apply
git apply --check -v "$tmp_fixed"
git apply "$tmp_fixed"
echo "Applied patch."

